#!/bin/bash
<% if p("disable") %>
<% else %>
set -e

install_if_missing ()
{
    echo "Installing $1"

    set +e
    dpkg -s $1
    dpkg_installed=$(echo $?)
    if [ "$dpkg_installed" != "0" ]; then
        for x in `seq 1 100` :
        do
          dpkg  --force-confdef -i $2
          if [ $? -ne 0 ] ; then
            sleep 3
          else
           set -e
           exit 0
          fi
        done
        set -e
        lsof -n
        exit 1
    else
        echo "Skipping $1"
    fi
    set -e
}

codename=$(lsb_release -c | awk '{print $2}')
if [ "$codename" == "trusty" ]; then
    (
    flock -x 200
    install_if_missing fuse /var/vcap/packages/mapfs-fuse/fuse_2.9.2-4ubuntu4.14.04.1_amd64.deb
    ) 200>/var/vcap/data/dpkg.lock
elif [ "$codename" == "xenial" ]; then
    (
    flock -x 200
    install_if_missing fuse /var/vcap/packages/mapfs-fuse/fuse_2.9.4-1ubuntu3.1_amd64.deb
    ) 200>/var/vcap/data/dpkg.lock
fi

modprobe fuse || true
groupadd fuse || true
adduser vcap fuse
chown root:fuse /dev/fuse
cat << EOF > /etc/fuse.conf
user_allow_other
EOF
chmod 644 /etc/fuse.conf

echo "Installing mapfs"

chown root:vcap /var/vcap/packages/mapfs/bin/mapfs
chmod 750 /var/vcap/packages/mapfs/bin/mapfs
chmod u+s /var/vcap/packages/mapfs/bin/mapfs
<% end %>